import * as HB from 'handlebars';
import {templateData, templates} from '../types';
import {existsSync, readFileSync, writeFileSync} from 'fs';
import {join} from 'path';
import {Model, ModelAttributeColumnOptions} from 'sequelize';

const fileExtention = 'template.hbs';

const format = (i: number) => {
  return i < 10 ? `0${i}` : i;
};

const getCurrentYYYYMMDDHHmms = () => {
  const date = new Date();
  return [
    date.getUTCFullYear(),
    format(date.getUTCMonth() + 1),
    format(date.getUTCDate()),
    format(date.getUTCHours()),
    format(date.getUTCMinutes()),
    format(date.getUTCSeconds()),
  ].join('');
};

const generateFileName = (
  templateName: templates,
  {tableName, columnName}: templateData
) => {
  const ts = getCurrentYYYYMMDDHHmms();
  const fileExtention = '.js';
  const separator = '-';
  switch (templateName) {
    case 'createTable':
      return [ts, 'create', tableName].join(separator) + fileExtention;
    case 'removeTable':
      return [ts, 'remove', tableName].join(separator) + fileExtention;
    case 'addColumn':
      return (
        [ts, 'add', columnName, 'to', tableName].join(separator) + fileExtention
      );
    case 'removeColumn':
      return (
        [ts, 'remove', columnName, 'from', tableName].join(separator) +
        fileExtention
      );
    case 'modifyColumn':
      return (
        [ts, 'modify', columnName, 'on', tableName].join(separator) +
        fileExtention
      );
    default:
      return [ts, 'migration'].join(separator) + fileExtention;
  }
};

const sleep = async (ms: number) =>
  new Promise(res => {
    setTimeout(() => {
      res(true);
    }, ms);
  });

const renderTemplate = async (
  templateName: templates,
  data: templateData,
  migrationsPath: string
) => {
  await sleep(1000);
  const templatePath = join(__dirname, `${templateName}.${fileExtention}`);
  if (!existsSync(templatePath)) {
    return Promise.reject('Template not found ' + templatePath);
  }
  HB.registerHelper(
    'formatAttributes',
    (
      arg1: ModelAttributeColumnOptions<Model<never, never>>,
      indent: string
    ) => {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const formatValue = (key: string, value: any): string => {
        if (key === 'type') {
          return `Sequelize.${value}`;
        }
        switch (typeof value) {
          case 'string':
            return `'${value}'`;
          case 'object':
            return JSON.stringify(value)
              .replace(/"([^"]+)":/g, '$1:')
              .replace(/"/g, "'");
          default:
            return `${value}`;
        }
      };
      // @ts-expect-error we know the eys exist
      // eslint-disable-next-line @typescript-eslint/no-unused-vars
      const {Model, _modelAttribute, field, _autoGenerated, ...rest} = arg1;
      return (
        Object.keys(rest)
          // @ts-expect-error shshsh
          .map(a => `${a}: ${formatValue(a, arg1[a])}`)
          .join(`,\n${new Array(parseInt(indent)).fill(' ').join('')}`) + ','
      );
    }
  );
  const template = HB.compile(readFileSync(templatePath).toString());
  const content = template(data);
  writeFileSync(
    join(migrationsPath, generateFileName(templateName, data)),
    content
  );
};

export default renderTemplate;
